# Алоритмы работы с ФН

Описание некоторых алгоритмов работы ККТ и фискального накопителя

## Обмен с ОФД

```mermaid
sequenceDiagram
    ККТ->>ФН: Начать чтение сообщения для ОФД 22h
    ККТ->>ФН: Чтение блока сообщения для ОФД 23h
    ККТ->>ФН: Завершить чтение данных 25h
    ККТ-->>+ОФД: Отпрвить сообщение из ФН
    ОФД-->>-ККТ: Получть квитанцию
    ККТ->>ФН: Передать квитанцию 26h
    Note right of ФН: Вовращает даные оператора для ККТ STLV (опция)
```

## Проверка кода маркировки (КМ)

```mermaid
sequenceDiagram
    ККТ->>ФН: Передача кода маркировки B1h
    ФН-->>ККТ: Запрос кода маркировки B5h
    ККТ->>+ОИСМ: Отправка запроса
    ОИСМ-->>-ККТ: Ответ
    ККТ->>ФН: Передача ответа на обработку B6h
    ККТ-->ККТ:Отображение результатов обработки
    ККТ->>ФН: Добавить маркированный товар в чек B2h
```

## Формирование кассового чека для маркированного товара

```mermaid
sequenceDiagram
    ККТ->>ФН: Начачать формирование документа
    ККТ->>ФН: Добавление реквизитов
    Note right of ККТ: тег 1059, тег 2007
    ККТ->>ФН: Завершить формирование ФД и одновременно создает уведомление о реализации маркированного товара
    ККТ->>+ОИСМ: Уведомление
    ОИСМ-->>-ККТ: Квитанция на уведомление

```
